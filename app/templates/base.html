<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>
      {% block title %}

      {% endblock %}
    </title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

</head>

<!-- –ö–Ω–æ–ø–∫–∞-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
<button class="weather-widget-toggle-btn" id="toggleWeather">
    üå§ –ü–æ–≥–æ–¥–∞
</button>

<body class="bg-dark text-light d-flex flex-column min-vh-100">

    <!-- –®–∞–ø–∫–∞ -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
        <div class="container">
            <a class="navbar-brand" href="#">{{ title|safe }}</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blog/">–ë–ª–æ–≥</a></li>
                    <li class="nav-item"><a class="nav-link" href="/form/">–ê–Ω–∫–µ—Ç–∞</a></li>
                    <li class="nav-item"><a class="nav-link" href="/contacts/">–ö–æ–Ω—Ç–∞–∫—Ç—ã</a></li>
                    {% if current_user.is_authenticated %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('routes.dashboard') }}">–ê–∫–∫–∞—É–Ω—Ç</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('routes.logout') }}">–í—ã—Ö–æ–¥</a></li>
                    {% else %}
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('routes.login') }}">–í—Ö–æ–¥</a></li>
                        <li class="nav-item"><a class="nav-link" href="{{ url_for('routes.register') }}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="container" style="padding-bottom: 120px;">
        <div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
                 <div class="alert alert-{{ category }} alert-dismissible fade show mt-3" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

        </div>
        {% block content %}

        {% endblock %}
    </main>

    <!-- –ü–æ–≥–æ–¥–Ω—ã–π –≤–∏–¥–∂–µ—Ç -->
    <div class="weather-widget-container">
        <div class="weather-widget">
            <div class="weather-content">
                <div class="weather-icon" id="weatherIcon"></div>
                <div class="temp" id="temperature">--¬∞</div>
                <div class="city" id="cityName">
                    <svg class="location-icon" viewBox="0 0 24 24">
                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                    </svg>
                    <span id="cityText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div class="condition" id="weatherCondition">--</div>
            </div>
        </div>
    </div>

    <!-- –§—É—Ç–µ—Ä -->
    <footer class="fixed-bottom bg-dark text-white text-center py-3">
        <p>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è: dersergeant@gmail.com</p>
        <div>
            <a href="https://www.facebook.com/DerSergeant" class="text-white me-3">Facebook</a>
            <a href="#" class="text-white me-3">Twitter</a>
            <a href="#" class="text-white">Instagram</a>
        </div>
    </footer>

    <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–≥–æ–¥–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ -->
<script>
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    const DEFAULT_CITY = '–ú–æ—Å–∫–≤–∞';  // –ü—Ä–∏–º–µ—Ä –≥–æ—Ä–æ–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–≥–æ–¥—ã
    function updateWeather(data) {
        const current = data.current;

        document.getElementById('cityText').textContent = data.location.name;
        document.getElementById('temperature').textContent = `${Math.round(current.temp_c)}¬∞`;
        document.getElementById('weatherCondition').textContent = current.condition.text;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫—É –∏–∑ API
        const iconUrl = `https:${current.condition.icon}`;
        const iconContainer = document.getElementById('weatherIcon');
        iconContainer.innerHTML = `<img src="${iconUrl}" alt="${current.condition.text}">`;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ
    async function getWeather(city) {
        try {
            const response = await fetch(`/api/weather/${encodeURIComponent(city)}`);
            const data = await response.json();

            if (data.error) throw new Error(data.error);
            updateWeather(data);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            if (city !== DEFAULT_CITY) {
                getWeather(DEFAULT_CITY);
            } else {
                document.getElementById('cityText').textContent = '–û—à–∏–±–∫–∞';
            }
        }
    }


    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ GPS
    async function detectLocationFromGPS() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;

                        try {
                            // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —á–µ—Ä–µ–∑ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                            const response = await fetch(`https://geocode.xyz/${lat},${lon}?geoit=json`);
                            const data = await response.json();
                            if (data.city) {
                                resolve(data.city);
                            } else {
                                reject('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≥–æ—Ä–æ–¥ –ø–æ GPS');
                            }
                        } catch (error) {
                            reject('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥–æ—Ä–æ–¥–∞ –ø–æ GPS');
                        }
                    },
                    (error) => {
                        reject('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GPS');
                    }
                );
            } else {
                reject('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è (—Å–Ω–∞—á–∞–ª–∞ GPS, –ø–æ—Ç–æ–º IP)
    async function detectLocation() {
        try {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ GPS
            const gpsLocation = await detectLocationFromGPS();
            return gpsLocation;
        } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ GPS:', error);
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º IP –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
            return await detectLocationByIP();
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –ø–æ IP
    async function detectLocationByIP() {
        try {
            const response = await fetch('/detect-location');
            const data = await response.json();

            if (data.city) {
                return data.city;
            }
        } catch (error) {
            console.log('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø–æ IP:', error);
        }

        return DEFAULT_CITY;
    }

    // –ö–ª–∏–∫ –ø–æ –≥–æ—Ä–æ–¥—É - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    document.getElementById('cityName').addEventListener('click', async () => {
        const city = await detectLocation();
        getWeather(city);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞
    async function initWidget() {
        const city = await detectLocation();
        getWeather(city);
    }

    // –ó–∞–ø—É—Å–∫ –≤–∏–¥–∂–µ—Ç–∞
    initWidget();
    document.getElementById('toggleWeather').addEventListener('click', () => {
    const container = document.querySelector('.weather-widget-container');
    container.classList.toggle('open');
    });
</script>


    {% if title == "–£—Ä–æ–∫ <strong>VD08</strong>" %}
    <script>
        function updateTime() {
            const now = new Date();
            const time = now.toLocaleTimeString();
            const date = now.toLocaleDateString();
            document.getElementById('clock').innerText = time;
            document.getElementById('date').innerText = date;
        }
        setInterval(updateTime, 1000);
        updateTime();
    </script>
    {% endif %}

    {% if title == "<strong>–ö–æ–Ω—Ç–∞–∫—Ç—ã</strong>" %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pdfPath = '/static/images/CV_prostyakov.pdf';
            const canvas = document.getElementById('pdf-canvas');
            const ctx = canvas.getContext('2d');

            pdfjsLib.getDocument(pdfPath).promise.then(pdf => {
                return pdf.getPage(1);
            }).then(page => {
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                page.render({ canvasContext: ctx, viewport: viewport });
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ PDF:', err);
            });
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>